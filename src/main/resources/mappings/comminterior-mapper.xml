<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  <mapper namespace="commInteriorDAO">
  		
  		<!-- 게시판 글쓰기 입력 -->
	 	<insert id="insertComm" parameterType="commInteriorVO">
	 		{ call
	 		declare
	 		begin
	 		INSERT INTO COMMUNITY
	 		(COM_SEQ, TITLE, NICK_NAME, CONTENT, REGDATE, HIT, TYPE)
	 		VALUES ((COMMMUNITY_SEQ.NEXTVAL) + 1, #{title}, #{nickName},
	 			#{content}, SYSDATE, 0, 2);
	 		INSERT INTO COMM_INTERIOR (COM_SEQ, FILE_IMAGE)
	 		VALUES ((select NVL(MAX(com_seq) ,0) FROM COMMUNITY), #{fileImage});
	 		END
	 		}
	 	</insert>
	 	
	  	<!-- 게시판 글 수정 -->
	  	<update id="updateComm" parameterType="commInteriorVO">
		  	{ call
		 		declare
		 		begin
		 		UPDATE COMMUNITY
		 		SET TITLE = #{title}, CONTENT = #{content}, REGDATE = SYSDATE
		 		WHERE COM_SEQ = #{comSeq};
		 		UPDATE COMM_INTERIOR
		 		SET FILE_IMAGE = #{fileImage}
		 		WHERE COM_SEQ = #{comSeq};
		 		END
		 	}
		</update>
	
		<!-- 게시판 조회수 증가 -->
		<update id="boardHitsUpdate" parameterType="Int">
			UPDATE COMMUNITY
			SET HIT = HIT + 1
			WHERE COM_SEQ = #{comSeq}
		</update>
	
		  	<!-- <update id="deleteArticle" parameterType="CommInteriorVO">
		 		{ call
		 		declare
		 		DELETE
		 		FROM COMMUNITY C, COMM_INTERIOR I
		 		WHERE COM_SEQ
		 		DELETE
		 		FROM COMMU
		 		END
		 		}
		</update> -->
	
		<!-- 게시판 글 삭제 -->
		<delete id="deleteComm" parameterType="commInteriorVO">
			{ call
		 		declare
		 		begin
		 		DELETE FROM COMMUNITY
		 		WHERE COM_SEQ = #{comSeq};
		 		DELETE FROM COMM_INTERIOR
		 		WHERE COM_SEQ = #{comSeq};
		 		END
		 	}
		</delete>
	
		<!-- 게시판 전체 글 갯수 -->
		<select id="selectAllCount" resultType="Integer">
			SELECT COUNT(*)
			FROM COMMUNITY C, COMM_INTERIOR I
			WHERE C.COM_SEQ = I.COM_SEQ
			AND TYPE = '2'
		</select>
		
		<!-- 게시판 전체 목록 조회 -->
		<select id="interiorAll" resultType="commInteriorVO" parameterType="hashmap">
			SELECT *
			FROM ( SELECT ROWNUM
			AS RECNUM,
			COM_SEQ,
			TITLE,
			NICK_NAME,
			CONTENT,
			TO_CHAR(SYSDATE, 'yyyy-mm-dd') as regdate,
			HIT,
			LIKES,
		       FILE_IMAGE
			FROM(SELECT C.COM_SEQ,
			C.TITLE,
			C.CONTENT,
			TO_CHAR(C.REGDATE, 'yyyy-mm-dd') as regdate,
			C.HIT,
			C.NICK_NAME,
			C.LIKES,
		       I.FILE_IMAGE
			FROM COMMUNITY C, COMM_INTERIOR I
			WHERE C.COM_SEQ = I.COM_SEQ AND TYPE = '2' ORDER BY C.COM_SEQ DESC))
			WHERE RECNUM BETWEEN (#{section}-1)* 90 +
			(#{pageNum}-1)* 9 + 1
			AND (#{section} - 1)*90 + #{pageNum}*9 ORDER BY
			COM_SEQ DESC
		</select>
  
  		<!-- 게시판 번호로 조회 -->
		<select id="getInteriorOne" parameterType="commInteriorVO" resultType="commInteriorVO">
			SELECT C.COM_SEQ, C.TITLE, C.NICK_NAME, C.CONTENT, C.REGDATE, C.HIT, C.LIKES, I.FILE_IMAGE
			FROM COMMUNITY C, COMM_INTERIOR I
			WHERE C.COM_SEQ = I.COM_SEQ
			AND C.COM_SEQ = #{comSeq}
			ORDER BY C.COM_SEQ , I.COM_SEQ
		</select>
	
		<!-- 좋아요 누름 -->
		<insert id="likesCheck" parameterType="likesVO">
	 		INSERT INTO LIKES
	 			(ID, COM_SEQ, LIKES)
	 		VALUES (#{id}, #{comSeq}, 1)
		</insert>
	  
	  	<!-- 좋아요 취소 -->
	 	<update id="likesCancel" parameterType="likesVO">
		 	UPDATE LIKES
		 	SET LIKES = 0
		 	WHERE COM_SEQ = #{comSeq} AND ID = #{id}
	  	</update>
	  	
	  	<!-- 해당 게시물 좋아요 수 조회 -->
	  	<select id="likesCount" resultType="Integer" parameterType="int">
	  		SELECT COUNT(LIKES)
	  		FROM LIKES
	  		WHERE COM_SEQ = #{comSeq}
	  	</select>
  </mapper>